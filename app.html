<!DOCTYPE html>
<html lang="uk">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
<title>#–ê–≥—Ä–æ_–º–æ—Ç–∏–≤–∞—à–∫–∞</title>
<link rel="preconnect" href="https://fonts.googleapis.com">
<link href="https://fonts.googleapis.com/css2?family=DM+Sans:wght@400;500;600;700&family=Plus+Jakarta+Sans:wght@500;600;700;800&display=swap" rel="stylesheet">
<link rel="stylesheet" href="css/style.css">
</head>
<body>

<!-- –ó–∞–≤–∞–Ω—Ç–∞–∂–µ–Ω–Ω—è -->
<div class="loading-overlay" id="loading">
  <span class="spinner" style="width:40px;height:40px;border-width:4px;"></span>
</div>

<!-- –û–≤–µ—Ä–ª–µ–π –¥–ª—è –º–æ–±—ñ–ª—å–Ω–æ–≥–æ –º–µ–Ω—é -->
<div class="overlay" id="overlay" onclick="closeSidebar()"></div>

<div class="app-layout">

  <!-- SIDEBAR -->
  <aside class="sidebar" id="sidebar">
    <div class="sidebar-brand">
      <div class="brand-mark">üåæ</div>
      <div>
        <div class="brand-name">#–ê–≥—Ä–æ_<em>–º–æ—Ç–∏–≤–∞—à–∫–∞</em></div>
        <div class="brand-sub">–î–î–ê–ï–£</div>
      </div>
    </div>

    <nav class="sidebar-nav" id="sidebar-nav">
      <div class="nav-group">–ì–æ–ª–æ–≤–Ω–µ</div>

      <a class="nav-link" data-page="dashboard" onclick="navigateTo('dashboard')">
        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><rect x="3" y="3" width="7" height="7" rx="1"/><rect x="14" y="3" width="7" height="7" rx="1"/><rect x="3" y="14" width="7" height="7" rx="1"/><rect x="14" y="14" width="7" height="7" rx="1"/></svg>
        Dashboard
      </a>

      <a class="nav-link" data-page="new-activity" onclick="navigateTo('new-activity')">
        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><circle cx="12" cy="12" r="10"/><line x1="12" y1="8" x2="12" y2="16"/><line x1="8" y1="12" x2="16" y2="12"/></svg>
        –ù–æ–≤–∏–π –∑–∞—Ö—ñ–¥
      </a>

      <a class="nav-link" data-page="activities" onclick="navigateTo('activities')">
        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><line x1="8" y1="6" x2="21" y2="6"/><line x1="8" y1="12" x2="21" y2="12"/><line x1="8" y1="18" x2="21" y2="18"/><line x1="3" y1="6" x2="3.01" y2="6"/><line x1="3" y1="12" x2="3.01" y2="12"/><line x1="3" y1="18" x2="3.01" y2="18"/></svg>
        –ú–æ—ó –∑–∞—Ö–æ–¥–∏
      </a>

      <a class="nav-link" data-page="ranking" onclick="navigateTo('ranking')">
        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><polyline points="22 12 18 12 15 21 9 3 6 12 2 12"/></svg>
        –†–µ–π—Ç–∏–Ω–≥
      </a>

      <div class="nav-group">–ü–æ–∫–∞–∑–Ω–∏–∫–∏</div>

      <a class="nav-link" data-page="smm" onclick="navigateTo('smm')">
        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M18 2h-3a5 5 0 0 0-5 5v3H7v4h3v8h4v-8h3l1-4h-4V7a1 1 0 0 1 1-1h3z"/></svg>
        SMM-–º–µ—Ç—Ä–∏–∫–∏
      </a>

      <a class="nav-link" data-page="other-metrics" onclick="navigateTo('other-metrics')">
        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><rect x="3" y="3" width="18" height="18" rx="2"/><path d="M3 9h18"/><path d="M9 21V9"/></svg>
        –Ü–Ω—à—ñ –ø–æ–∫–∞–∑–Ω–∏–∫–∏
      </a>

      <!-- –í–µ—Ä–∏—Ñ—ñ–∫–∞—Ü—ñ—è ‚Äî —Ç—ñ–ª—å–∫–∏ –¥–ª—è admin —Ç–∞ verifier -->
      <div id="nav-verify-section" style="display:none">
        <div class="nav-group">–í–µ—Ä–∏—Ñ—ñ–∫–∞—Ü—ñ—è</div>
        <a class="nav-link" data-page="verify" onclick="navigateTo('verify')">
          <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M22 11.08V12a10 10 0 1 1-5.93-9.14"/><polyline points="22 4 12 14.01 9 11.01"/></svg>
          –ù–∞ –ø–µ—Ä–µ–≤—ñ—Ä–∫—É
          <span class="nav-count" id="verify-count" style="display:none">0</span>
        </a>
      </div>

      <!-- –ê–¥–º—ñ–Ω—ñ—Å—Ç—Ä—É–≤–∞–Ω–Ω—è ‚Äî —Ç—ñ–ª—å–∫–∏ –¥–ª—è admin -->
      <div id="nav-admin-section" style="display:none">
        <div class="nav-group">–ê–¥–º—ñ–Ω—ñ—Å—Ç—Ä—É–≤–∞–Ω–Ω—è</div>
        <a class="nav-link" data-page="users" onclick="navigateTo('users')">
          <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M17 21v-2a4 4 0 0 0-4-4H5a4 4 0 0 0-4 4v2"/><circle cx="9" cy="7" r="4"/></svg>
          –ö–æ—Ä–∏—Å—Ç—É–≤–∞—á—ñ
        </a>
        <a class="nav-link" data-page="settings" onclick="navigateTo('settings')">
          <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><circle cx="12" cy="12" r="3"/><path d="M19.4 15a1.65 1.65 0 0 0 .33 1.82l.06.06a2 2 0 0 1-2.83 2.83l-.06-.06a1.65 1.65 0 0 0-1.82-.33 1.65 1.65 0 0 0-1 1.51V21a2 2 0 0 1-4 0v-.09A1.65 1.65 0 0 0 9 19.4a1.65 1.65 0 0 0-1.82.33l-.06.06a2 2 0 0 1-2.83-2.83l.06-.06A1.65 1.65 0 0 0 4.68 15a1.65 1.65 0 0 0-1.51-1H3a2 2 0 0 1 0-4h.09"/></svg>
          –ù–∞–ª–∞—à—Ç—É–≤–∞–Ω–Ω—è
        </a>
      </div>
    </nav>

    <div class="sidebar-footer">
      <div class="avatar" id="user-avatar">‚Äî</div>
      <div style="flex:1;min-width:0;">
        <div class="avatar-name" id="user-name">–ó–∞–≤–∞–Ω—Ç–∞–∂–µ–Ω–Ω—è...</div>
        <div class="avatar-role" id="user-role"></div>
      </div>
      <button onclick="logout()" title="–í–∏–π—Ç–∏" style="background:none;border:none;cursor:pointer;padding:6px;border-radius:8px;color:var(--text-muted);">
        <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M9 21H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h4"/><polyline points="16 17 21 12 16 7"/><line x1="21" y1="12" x2="9" y2="12"/></svg>
      </button>
    </div>
  </aside>

  <!-- MAIN -->
  <main class="main-area">
    <header class="topbar">
      <div class="topbar-left">
        <button class="burger" onclick="openSidebar()">
          <svg width="22" height="22" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><line x1="3" y1="6" x2="21" y2="6"/><line x1="3" y1="12" x2="21" y2="12"/><line x1="3" y1="18" x2="21" y2="18"/></svg>
        </button>
        <h1 class="topbar-title" id="page-title">Dashboard</h1>
      </div>
      <div class="topbar-right">
        <!-- –¢—É—Ç –º–æ–∂—É—Ç—å –±—É—Ç–∏ —Å–ø–æ–≤—ñ—â–µ–Ω–Ω—è, –ø–æ—à—É–∫ —Ç–æ—â–æ -->
      </div>
    </header>

    <div class="page-area" id="page-content">
      <!-- –°—é–¥–∏ —Ä–æ—É—Ç–µ—Ä –≤—Å—Ç–∞–≤–ª—è—î –≤–º—ñ—Å—Ç —Å—Ç–æ—Ä—ñ–Ω–∫–∏ -->
    </div>
  </main>

</div>

<!-- Supabase -->
<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2/dist/umd/supabase.min.js"></script>

<!-- –Ø–¥—Ä–æ –¥–æ–¥–∞—Ç–∫—É -->
<script src="js/config.js"></script>
<script src="js/auth.js"></script>
<script src="js/router.js"></script>

<!-- –°—Ç–æ—Ä—ñ–Ω–∫–∏ -->
<script src="pages/dashboard.js"></script>
<script src="pages/new-activity.js"></script>
<script src="pages/activities.js"></script>
<script src="pages/verify.js"></script>
<script src="pages/ranking.js"></script>
<script src="pages/users.js"></script>
<script src="pages/settings.js"></script>
<script src="pages/smm.js"></script>
<script src="pages/other-metrics.js"></script>

<!-- –Ü–Ω—ñ—Ü—ñ–∞–ª—ñ–∑–∞—Ü—ñ—è -->
<script>
var ROLE_LABELS = {
  admin: '–ê–¥–º—ñ–Ω—ñ—Å—Ç—Ä–∞—Ç–æ—Ä',
  verifier: '–í–µ—Ä–∏—Ñ—ñ–∫–∞—Ç–æ—Ä',
  rectorate: '–†–µ–∫—Ç–æ—Ä–∞—Ç',
  participant: '–£—á–∞—Å–Ω–∏–∫'
};

(async function init() {
  // –ü–µ—Ä–µ–≤—ñ—Ä–∏—Ç–∏ –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü—ñ—é
  var user = await checkAuth();

  if (!user) {
    window.location.href = 'index.html';
    return;
  }

  // –ó–±–µ—Ä–µ–≥—Ç–∏ –∫–æ—Ä–∏—Å—Ç—É–≤–∞—á–∞
  currentUser = user;

  // –û–Ω–æ–≤–∏—Ç–∏ UI –∑ –¥–∞–Ω–∏–º–∏ –∫–æ—Ä–∏—Å—Ç—É–≤–∞—á–∞
  var initials = user.full_name.split(' ').map(function(w) { return w[0]; }).join('').substring(0, 2);
  document.getElementById('user-avatar').textContent = initials;
  document.getElementById('user-name').textContent = user.full_name;

  var roleName = ROLE_LABELS[user.role] || user.role;
  var deptName = user.departments ? user.departments.short_name : '';
  document.getElementById('user-role').textContent = roleName + (deptName ? ' ¬∑ ' + deptName : '');

  // –ü–æ–∫–∞–∑–∞—Ç–∏ –º–µ–Ω—é –≤—ñ–¥–ø–æ–≤—ñ–¥–Ω–æ –¥–æ —Ä–æ–ª—ñ
  if (user.role === 'admin' || user.role === 'verifier') {
    document.getElementById('nav-verify-section').style.display = 'block';
    // –ó–∞–≤–∞–Ω—Ç–∞–∂–∏—Ç–∏ –∫—ñ–ª—å–∫—ñ—Å—Ç—å –∑–∞—Ö–æ–¥—ñ–≤ –Ω–∞ –ø–µ—Ä–µ–≤—ñ—Ä–∫—É
    loadVerifyCount();
  }

  if (user.role === 'admin') {
    document.getElementById('nav-admin-section').style.display = 'block';
  }

  // –°—Ö–æ–≤–∞—Ç–∏ –∑–∞–≤–∞–Ω—Ç–∞–∂–µ–Ω–Ω—è
  document.getElementById('loading').style.display = 'none';

  // –ü–µ—Ä–µ–π—Ç–∏ –Ω–∞ –ø–æ—Ç—Ä—ñ–±–Ω—É —Å—Ç–æ—Ä—ñ–Ω–∫—É
  var startPage = getPageFromURL();
  navigateTo(startPage);
})();

async function loadVerifyCount() {
  var result = await db
    .from('activities')
    .select('id', { count: 'exact', head: true })
    .eq('status', 'submitted');

  if (!result.error && result.count > 0) {
    var badge = document.getElementById('verify-count');
    badge.textContent = result.count;
    badge.style.display = 'inline';
  }
}
</script>
</body>
</html>
